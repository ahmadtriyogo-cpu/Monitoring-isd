<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Aplikasi Substitusi Driver — V3 Mobile</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F5F7FA; --card:#FFFFFF; --primary:#0B3C91; --accent:#2E8BFF; --muted:#6B7280; --danger:#DC2626;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial;background:var(--bg);margin:0;color:#0f172a}
    .app{max-width:480px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
    header{padding:14px 16px;background:linear-gradient(90deg,var(--primary),#1446a0);color:white}
    header .title{font-size:16px;font-weight:600}
    header .subtitle{font-size:12px;opacity:0.9;margin-top:4px}

    main{flex:1;padding:12px}
    .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(11,60,145,0.06)}
    .row{display:flex;gap:8px;align-items:center}
    input,select,textarea,button{font-family:Inter;font-size:14px}
    input,select,textarea{padding:10px;border:1px solid #e6eef8;border-radius:10px;width:100%}
    button.btn{background:var(--accent);color:white;padding:10px 12px;border-radius:10px;border:none}
    button.ghost{background:#f3f4f6;color:#111;border:1px solid #e6eef8}
    .small{font-size:12px;color:var(--muted)}

    /* bottom nav */
    nav.bottom{position:fixed;left:0;right:0;bottom:0;background:white;border-top:1px solid #eef2f7;display:flex;justify-content:space-around;padding:8px 0}
    nav.bottom .tab{display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--muted);gap:4px}
    nav.bottom .tab.active{color:var(--primary);font-weight:600}

    /* lists */
    .list .item{display:flex;gap:8px;align-items:center;padding:10px;border-radius:10px;border:1px solid #eef4ff;margin-bottom:8px}
    .pill{background:#eef2ff;color:var(--primary);padding:6px 8px;border-radius:999px;font-weight:600}
    a.phone{color:var(--primary);text-decoration:none;font-weight:600}

    /* ISD card */
    .isd-card{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:12px;padding:10px;border:1px solid #e6eefc;margin-bottom:10px}
    .history{background:#fff7ed;border-left:4px solid #f59e0b;padding:8px;border-radius:8px;margin-top:8px;font-size:13px;color:#92400e}

    /* modal */
    .modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(2,6,23,0.5);display:flex;align-items:center;justify-content:center}
    .modal .box{background:white;padding:12px;border-radius:12px;max-width:420px;width:92%;max-height:80vh;overflow:auto}

    /* responsive tweaks */
    @media(min-width:480px){ .app{margin-top:18px;border-radius:18px;box-shadow:0 12px 30px rgba(2,6,23,0.06)} }

    .fab{position:fixed;right:18px;bottom:70px;background:var(--accent);color:white;width:56px;height:56px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 8px 20px rgba(46,139,255,0.2);border:none}

    .status-badge{padding:6px 8px;border-radius:10px;font-weight:600;font-size:12px}
    .s-green{background:#ECFDF5;color:#065F46}
    .s-red{background:#FEF2F2;color:#B91C1C}
    .s-yellow{background:#FFFBEB;color:#92400E}
    .s-orange{background:#FFF7ED;color:#C2410C}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div class="title">Aplikasi Substitusi Driver — V3</div>
      <div class="subtitle">Material UI • Fullscreen Mobile • Auto WA • localStorage</div>
    </header>

    <main id="main">
      <!-- AHT Screen -->
      <section id="screen-aht" class="screen">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600">Update Driver Substitusi</div>
              <div class="small">Tanggal: <span id="ahtTitleDate"></span> • Shift: <span id="ahtTitleShift"></span></div>
            </div>
            <div class="pill" id="ahtCount">0</div>
          </div>
        </div>

        <div class="card">
          <div class="small">Upload CSV Database</div>
          <div style="margin-top:8px" class="row">
            <input type="file" id="csvIn" accept=".csv" />
          </div>
          <div style="margin-top:8px" class="row">
            <button class="btn" id="loadCsv">Load & Simpan</button>
            <button class="ghost" id="exportDb">Export DB</button>
          </div>
          <div class="small" style="margin-top:8px">Format CSV: <code>nama,telepon,no_lambung,status</code></div>
        </div>

        <div class="card">
          <div class="small">Cari Database</div>
          <div style="margin-top:8px" class="row"><input id="dbSearch" placeholder="Cari nama / no hp / no lambung" /><button class="ghost" id="clearSearch">Clear</button></div>
          <div id="dbList" style="margin-top:8px;max-height:200px;overflow:auto" class="list"></div>
        </div>

        <div class="card">
          <div class="small">Input Manual Substitusi</div>
          <div style="margin-top:8px" class="row">
            <input id="manualName" placeholder="Nama pengganti" />
          </div>
          <div style="margin-top:8px" class="row">
            <input id="manualPhone" placeholder="No HP (08...)" style="width:50%" />
            <select id="manualShift" style="width:50%">
              <option value="pagi">Pagi</option>
              <option value="malam">Malam</option>
            </select>
          </div>
          <div style="margin-top:8px" class="row">
            <input type="date" id="manualDate" style="width:50%" />
            <button class="btn" id="addManual" style="width:48%">Tambah Substitusi</button>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">List Substitusi</div>
            <div class="small">Tgl: <input type="date" id="subsDate" /></div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <select id="subsShift" style="width:40%"><option value="pagi">Pagi</option><option value="malam">Malam</option></select>
            <button class="btn" id="processChecked">Proses Checkbox → Substitusi</button>
            <button class="ghost" id="copySubs">Copy WA</button>
          </div>
          <div id="subsList" style="margin-top:10px;max-height:220px;overflow:auto" class="list"></div>
        </div>

        <div class="card">
          <div style="font-weight:600">Feedback ISD (Tanggal Dipilih)</div>
          <div class="small">Tgl: <input type="date" id="fbDate" /> Shift: <select id="fbShift"><option value="pagi">Pagi</option><option value="malam">Malam</option></select></div>
          <div id="ahtFeedback" style="margin-top:8px;max-height:220px;overflow:auto"></div>
        </div>
      </section>

      <!-- ISD Screen -->
      <section id="screen-isd" class="screen" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-weight:600">ISD — Tindak Lanjut</div><div class="small">Ambil data AHT & catat status armada</div></div>
            <div class="pill" id="isdCount">0</div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:600">Ambil dari AHT</div>
          <div id="takeFromAht" style="margin-top:8px;max-height:200px;overflow:auto" class="list"></div>
        </div>

        <div class="card">
          <div style="font-weight:600">Tambah Status Armada</div>
          <div style="margin-top:8px" class="row"><input id="armNo" placeholder="No Lambung / ID Armada" /><input id="armPhone" placeholder="No HP pengganti (opsional)" /></div>
          <div style="margin-top:8px" class="row"><select id="armStatus"><option value="kosong">Kosong</option><option value="standby">Standby</option><option value="oper">Oper</option><option value="turun">Turun</option><option value="aktif">Aktif</option></select><input id="armTeam" placeholder="Petugas (team stamp)" /></div>
          <div style="margin-top:8px" class="row"><input id="armNote" placeholder="Keterangan" /><button class="btn" id="addArm">Tambah</button></div>
        </div>

        <div class="card">
          <div style="font-weight:600">List ISD (History & Update)</div>
          <div id="isdCards" style="margin-top:8px;max-height:320px;overflow:auto"></div>
        </div>
      </section>

      <!-- Manager Screen -->
      <section id="screen-mgr" class="screen" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:600">Manager — Rangkuman</div><div class="small">Generate laporan gabungan AHT + ISD</div></div><div class="pill" id="mgrCount">-</div></div>
        </div>

        <div class="card">
          <div class="row"><input type="date" id="mgrDate" /><select id="mgrShift"><option value="pagi">Pagi</option><option value="malam">Malam</option></select><button class="btn" id="genMgr">Generate</button></div>
          <div id="mgrReport" style="margin-top:12px;max-height:360px;overflow:auto"></div>
        </div>
      </section>

    </main>

    <button class="fab" id="fab">+</button>

    <nav class="bottom">
      <div class="tab active" data-screen="aht"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 5h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><div>AHT</div></div>
      <div class="tab" data-screen="isd"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><div>ISD</div></div>
      <div class="tab" data-screen="mgr"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><div>Manager</div></div>
    </nav>

    <!-- Modal (history) -->
    <div id="modal" style="display:none" class="modal"><div class="box"><div id="modalContent"></div><div style="margin-top:10px;text-align:right"><button class="ghost" id="closeModal">Close</button></div></div></div>

  <script>
    // Store
    const KEY = 'AHT_ISD_V3';
    let store = { db:[], subs:[], isd:[], arm:[] };
    function save(){ localStorage.setItem(KEY, JSON.stringify(store)); }
    function load(){ const s = localStorage.getItem(KEY); if(s) store = JSON.parse(s); renderAll(); }

    // Helpers
    function uid(){return Math.random().toString(36).slice(2,9)}
    function esc(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }
    function phoneToWa(p){ if(!p) return ''; let s=(p||'').toString().replace(/[^0-9]/g,''); if(s.startsWith('0')) s='62'+s.slice(1); if(!s.startsWith('62')) s='62'+s; return s; }
    function csvToRows(txt){ return txt.split(/?
/).map(r=>r.trim()).filter(Boolean).map(r=>r.split(',').map(c=>c.replace(/^\"|\"$/g,'').trim())); }
    function download(name,content){ const b=new Blob([content],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

    // UI controls
    document.querySelectorAll('nav.bottom .tab').forEach(t=>t.addEventListener('click', ()=>{ document.querySelectorAll('nav.bottom .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); document.querySelectorAll('main .screen').forEach(s=>s.style.display='none'); document.getElementById('screen-'+t.dataset.screen).style.display='block'; }));
    document.getElementById('fab').addEventListener('click', ()=>{ // quick add manual subs
      document.getElementById('manualName').focus(); window.scrollTo({top:0,behavior:'smooth'});
    });

    // CSV load
    document.getElementById('loadCsv').addEventListener('click', ()=>{
      const f = document.getElementById('csvIn').files[0]; if(!f){alert('Pilih file CSV');return}
      const r = new FileReader(); r.onload = ()=>{ try{ const rows = csvToRows(r.result); const parsed = []; rows.forEach(row=>{ if(row.length>=2) parsed.push({id:uid(), nama:row[0], telepon:row[1], no_lambung:row[2]||'', status:row[3]||''}); }); store.db = parsed; save(); renderDb(); alert('Database tersimpan'); }catch(e){alert('Error CSV:'+e.message)} }; r.readAsText(f,'utf-8'); });
    document.getElementById('exportDb').addEventListener('click', ()=>{ if(store.db.length===0){alert('DB kosong');return} const head='nama,telepon,no_lambung,status
'; const rows = store.db.map(d=>`\"${d.nama.replace(/\"/g,'\"\"')}\",\"${d.telepon}\",\"${d.no_lambung}\",\"${d.status}\"`).join('
'); download('db.csv',head+rows); });

    // render DB
    document.getElementById('dbSearch').addEventListener('input', renderDb);
    document.getElementById('clearSearch').addEventListener('click', ()=>{ document.getElementById('dbSearch').value=''; renderDb(); });

    function renderDb(){ const q=(document.getElementById('dbSearch').value||'').toLowerCase(); const wrap=document.getElementById('dbList'); wrap.innerHTML=''; if(store.db.length===0){ wrap.innerHTML='<div class="small">DB kosong</div>'; return }
      store.db.forEach((d,i)=>{ if(q && !(d.nama||'').toLowerCase().includes(q) && !(d.telepon||'').toLowerCase().includes(q) && !(d.no_lambung||'').toLowerCase().includes(q)) return; const div=document.createElement('div'); div.className='item'; div.innerHTML=`<div style=\"flex:1\"><div style=\"font-weight:600\">${esc(d.nama)}</div><div class=\"small\">${esc(d.status)} • ${esc(d.no_lambung)}</div></div><div style=\"text-align:right\"><a class=\"phone small\" href=\"https://wa.me/${phoneToWa(d.telepon)}\" target=\"_blank\">${esc(d.telepon)}</a><div style=\"margin-top:8px\"><input type=checkbox class=dbChk data-idx=${i} /></div></div>`; wrap.appendChild(div); }); }

    // manual add
    document.getElementById('addManual').addEventListener('click', ()=>{
      const n=document.getElementById('manualName').value.trim(); const p=document.getElementById('manualPhone').value.trim(); const sh=document.getElementById('manualShift').value; const dt=document.getElementById('manualDate').value||new Date().toISOString().slice(0,10);
      if(!n||!p){alert('Isi nama & hp');return}
      store.subs.push({id:uid(), nama:n, telepon:p, shift:sh, date:dt, ready:true}); save(); renderSubs(); document.getElementById('manualName').value=''; document.getElementById('manualPhone').value=''; updateCounts(); });

    // process checked
    document.getElementById('processChecked').addEventListener('click', ()=>{
      const checks = Array.from(document.querySelectorAll('.dbChk:checked')).map(x=>Number(x.dataset.idx)); if(checks.length===0){alert('Pilih dari DB');return}
      const dt=document.getElementById('subsDate').value||new Date().toISOString().slice(0,10); const sh=document.getElementById('subsShift').value;
      checks.forEach(i=>{ const d=store.db[i]; if(d) store.subs.push({id:uid(), nama:d.nama, telepon:d.telepon, shift:sh, date:dt, ready:true}); }); save(); renderSubs(); renderDb(); updateCounts(); alert('Diproses ke substitusi'); });

    // render subs list
    document.getElementById('subsDate').value = new Date().toISOString().slice(0,10);
    function renderSubs(){ const dt=document.getElementById('subsDate').value; const sh=document.getElementById('subsShift').value; const wrap=document.getElementById('subsList'); wrap.innerHTML=''; const list=store.subs.filter(s=>s.date===dt && s.shift===sh);
      if(list.length===0){ wrap.innerHTML='<div class=\"small\">Belum ada substitusi</div>'; document.getElementById('ahtCount').innerText='0'; return }
      list.forEach(s=>{ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<div style=\"flex:1\"><div style=\"font-weight:600\">${esc(s.nama)}</div><div class=\"small\">${esc(s.shift)} • ${esc(s.date)}</div></div><div style=\"text-align:right\"><a class=\"phone small\" href=\"https://wa.me/${phoneToWa(s.telepon)}\" target=\"_blank\">${esc(s.telepon)}</a><div style=\"margin-top:8px\"><button class=\"btn\" data-id=\"${s.id}\" data-act=\"toIsd\">Ambil ISD</button></div></div>`; wrap.appendChild(div); });
      document.querySelectorAll('button[data-act=\"toIsd\"]').forEach(b=>b.addEventListener('click', ()=>{ const id=b.dataset.id; const s=store.subs.find(x=>x.id===id); if(!s) return; store.isd.push({id:uid(), fromSubId:s.id, nama:s.nama, telepon:s.telepon, shift:s.shift, date:s.date, status:'ready', no_lambung:'', history:[{ts:new Date().toISOString(),team:'AHT',note:'ready'}]}); save(); renderIsdCards(); alert('Terkirim ke ISD (status: ready)'); }));
      document.getElementById('ahtCount').innerText=list.length;
    }

    document.getElementById('copySubs').addEventListener('click', ()=>{ const dt=document.getElementById('subsDate').value; const sh=document.getElementById('subsShift').value; const list=store.subs.filter(s=>s.date===dt && s.shift===sh); if(list.length===0){alert('Kosong');return} const lines=[`LIST DRIVER SUBSTITUSI - SHIFT ${sh.toUpperCase()} (${format(dt)})`]; list.forEach((s,i)=>lines.push(`${i+1}. ${s.nama} - ${s.telepon} - READY`)); navigator.clipboard.writeText(lines.join('
')).then(()=>alert('Disalin')); });

    // Feedback AHT render (table-like)
    document.getElementById('fbDate').value = new Date().toISOString().slice(0,10);
    function renderAhtFeedback(){ const dt=document.getElementById('fbDate').value; const sh=document.getElementById('fbShift').value; const wrap=document.getElementById('ahtFeedback'); wrap.innerHTML=''; const items = store.isd.filter(i=>i.date===dt && i.shift===sh);
      if(items.length===0){ wrap.innerHTML='<div class=\"small\">Belum ada feedback ISD untuk tanggal/shift ini</div>'; return }
      // build table header
      const header = document.createElement('div'); header.style.display='flex'; header.style.gap='8px'; header.style.fontWeight='600'; header.style.marginBottom='8px'; header.innerHTML = '<div style=\"flex:2\">Nama</div><div style=\"flex:2\">HP</div><div style=\"flex:1\">Shift</div><div style=\"flex:1\">Status</div><div style=\"flex:1\">No</div><div style=\"flex:1\">Jam</div><div style=\"flex:1\">Petugas</div><div style=\"flex:2\">Catatan</div><div style=\"width:36px\"></div>'; wrap.appendChild(header);
      items.forEach(it=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.marginBottom='8px';
        const last = (it.history && it.history.length>0) ? it.history[it.history.length-1] : {ts:'',team:'',note:''};
        // status color
        let cls='s-green'; if(last.status && last.status.toLowerCase().includes('tidak')) cls='s-red'; else if(last.status && last.status.toLowerCase().includes('turun')) cls='s-orange'; else if(last.status && last.status.toLowerCase().includes('ijin')) cls='s-yellow';
        row.innerHTML = `<div style=\"flex:2\">${esc(it.nama)}</div><div style=\"flex:2\"><a class=phone href=\'https://wa.me/${phoneToWa(it.telepon)}\' target=\'_blank\'>${esc(it.telepon)}</a></div><div style=\"flex:1\">${esc(it.shift)}</div><div style=\"flex:1\"><span class='status-badge ${cls}'>${esc(last.status||it.status||'')}</span></div><div style=\"flex:1\">${esc(it.no_lambung||'')}</div><div style=\"flex:1\">${last.ts?format(last.ts):''}</div><div style=\"flex:1\">${esc(last.team||'')}</div><div style=\"flex:2\">${esc(last.note||'')}</div><div style='width:36px'><button class=\"ghost\" data-id=\'${it.id}\' data-act=\'hist\'>...</button></div>`;
        wrap.appendChild(row);
      });
      // wire history buttons
      wrap.querySelectorAll('button[data-act=\"hist\"]').forEach(b=>b.addEventListener('click', ()=>{ const id=b.dataset.id; const it = store.isd.find(x=>x.id===id); if(!it) return; showModalHistory(it); }));
    }

    document.getElementById('fbDate').addEventListener('change', renderAhtFeedback); document.getElementById('fbShift').addEventListener('change', renderAhtFeedback);

    // ISD cards render
    function renderIsdCards(){ const wrap=document.getElementById('isdCards'); wrap.innerHTML=''; if(store.isd.length===0){ wrap.innerHTML='<div class=\"small\">Belum ada ISD</div>'; document.getElementById('isdCount').innerText='0'; return }
      store.isd.slice().reverse().forEach(it=>{
        const div=document.createElement('div'); div.className='isd-card';
        const last = (it.history && it.history.length>0) ? it.history[it.history.length-1] : {ts:'',team:'',note:'',status:it.status};
        div.innerHTML = `<div style='display:flex;justify-content:space-between;align-items:center'><div><strong>${esc(it.nama)}</strong><div class='small'>${esc(it.telepon)} • ${esc(it.shift)} • ${esc(it.date)}</div></div><div><a class='phone' href='https://wa.me/${phoneToWa(it.telepon)}' target='_blank'>WA</a></div></div>`;
        const form = document.createElement('div'); form.style.marginTop='8px'; form.innerHTML = `<div style='display:flex;gap:8px;flex-wrap:wrap'><select class='s-status'><option value='naik armada'>Naik Armada</option><option value='tidak respon'>Tidak Respon</option><option value='turun oper'>Turun Oper</option><option value='turun ijin'>Turun (ijin/sakit)</option><option value='ready'>READY</option></select><input class='s-nl' placeholder='No Lambung' style='width:120px' /><input class='s-team' placeholder='Team stamp' style='width:120px' /><input class='s-note' placeholder='Catatan' style='flex:1' /><button class='btn s-save'>Simpan</button><button class='ghost s-del'>Hapus</button></div>`;
        div.appendChild(form);
        // history
        const hist = document.createElement('div'); hist.className='history'; hist.innerHTML = '<div style="font-weight:600">History</div>';
        if(it.history && it.history.length>0){ it.history.slice().reverse().forEach(h=>{ const p=document.createElement('div'); p.className='small'; p.style.marginTop='6px'; p.textContent = `${format(h.ts)} • ${h.team} • ${h.status}${h.note?(' • '+h.note):''}`; hist.appendChild(p); }); } else { const p=document.createElement('div'); p.className='small'; p.style.marginTop='6px'; p.textContent='Belum ada history'; hist.appendChild(p); }
        div.appendChild(hist);
        wrap.appendChild(div);
        // wire events
        const sel = div.querySelector('.s-status'); const nl = div.querySelector('.s-nl'); const t = div.querySelector('.s-team'); const note = div.querySelector('.s-note'); const save = div.querySelector('.s-save'); const del = div.querySelector('.s-del');
        sel.value = it.status || 'ready'; nl.value = it.no_lambung || '';
        save.addEventListener('click', ()=>{ const st=sel.value; const no=nl.value.trim(); const team=t.value.trim()||'ISD'; const nt=note.value.trim(); const idx = store.isd.findIndex(x=>x.id===it.id); if(idx===-1) return; store.isd[idx].status = st; store.isd[idx].no_lambung = no; if(!store.isd[idx].history) store.isd[idx].history=[]; store.isd[idx].history.push({ts:new Date().toISOString(), team:team, status:st, note:nt}); save(); renderIsdCards(); renderAhtFeedback(); updateCounts(); alert('Tersimpan & history ditambah'); });
        del.addEventListener('click', ()=>{ if(!confirm('Hapus item ISD?')) return; store.isd = store.isd.filter(x=>x.id!==it.id); save(); renderIsdCards(); renderAhtFeedback(); updateCounts(); });
      });
      document.getElementById('isdCount').innerText = store.isd.length;
    }

    // add arm status
    document.getElementById('addArm').addEventListener('click', ()=>{
      const no=document.getElementById('armNo').value.trim(); const phone=document.getElementById('armPhone').value.trim(); const status=document.getElementById('armStatus').value; const team=document.getElementById('armTeam').value.trim()||'ISD'; const note=document.getElementById('armNote').value.trim(); const dt=new Date().toISOString().slice(0,10);
      if(!no){alert('Isi no lambung');return}
      const id=uid(); const entry={id, no_lambung:no, telepon:phone, status, team, note, ts:new Date().toISOString()}; store.arm.push(entry); // also push to isd aggregated view
      // push to isd log as well
      store.isd.push({id:uid(), fromSubId:null, nama:'Armada '+no, telepon:phone, shift:'-', date:dt, status:status, no_lambung:no, history:[{ts:new Date().toISOString(), team:team, status:status, note:note}]});
      save(); renderIsdCards(); renderOffReport(); updateCounts(); alert('Status armada ditambahkan'); document.getElementById('armNo').value=''; document.getElementById('armPhone').value=''; document.getElementById('armNote').value='';
    });

    // render off report (manager use)
    function renderOffReport(){ /* kept for manager */ }

    // manager generate
    document.getElementById('genMgr').addEventListener('click', ()=>{
      const dt=document.getElementById('mgrDate').value||new Date().toISOString().slice(0,10); const sh=document.getElementById('mgrShift').value; const subs = store.subs.filter(s=>s.date===dt && s.shift===sh); const isds = store.isd.filter(i=>i.date===dt && (i.shift===sh || i.shift==='-'));
      const lines=[]; lines.push(`LAPORAN OPERASIONAL (${format(dt)} - SHIFT ${sh.toUpperCase()})`); lines.push(`Substitusi (AHT): ${subs.length}`); lines.push(`Total ISD entries: ${isds.length}`); lines.push(`Naik Armada: ${isds.filter(i=>i.status==='naik armada').length}`); lines.push(`Turun Oper: ${isds.filter(i=>i.status==='turun oper').length}`); lines.push(`Tidak Respon: ${isds.filter(i=>i.status==='tidak respon').length}`); lines.push(''); lines.push('Detail ISD:'); isds.forEach(i=>{ const last=i.history && i.history.length? i.history[i.history.length-1]: {}; lines.push(`${i.nama} - ${i.status} ${i.no_lambung?('(No:'+i.no_lambung+')'):''} • ${last.ts?format(last.ts):''} • ${last.team||''} • ${last.note||''}`); }); document.getElementById('mgrReport').innerHTML = `<pre>${esc(lines.join('
'))}</pre>`; document.getElementById('mgrCount').innerText = isds.length; document.getElementById('exportMgr').onclick = ()=>download(`laporan_${dt}.txt`, lines.join('
'));
    });

    // modal history
    function showModalHistory(item){ const box=document.getElementById('modal'); const content=document.getElementById('modalContent'); content.innerHTML = `<h3>${esc(item.nama)}</h3>`; if(item.history && item.history.length>0){ item.history.slice().reverse().forEach(h=>{ const p=document.createElement('div'); p.className='small'; p.style.marginTop='8px'; p.textContent = `${format(h.ts)} • ${h.team} • ${h.status} ${h.note?('• '+h.note):''}`; content.appendChild(p); }); } else { content.innerHTML += '<div class="small">Tidak ada history</div>'; } box.style.display='flex'; }
    document.getElementById('closeModal').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });

    // utility: update counts
    function updateCounts(){ document.getElementById('ahtCount').innerText = store.subs.length; document.getElementById('isdCount').innerText = store.isd.length; }

    function format(d){ if(!d) return ''; const dt=new Date(d); return dt.toLocaleString('id-ID'); }

    // initial render
    function renderAll(){ renderDb(); renderSubs(); renderIsdCards(); renderAhtFeedback(); updateCounts(); }
    load();
  </script>
</body>
</html>