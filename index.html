<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AHT · ISD · Manager — Aplikasi Substitusi Driver</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--accent:#2563eb}
    body{font-family:Inter, system-ui, Arial; background:var(--bg); margin:0;padding:18px}
    .app{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:18px;margin:0}
    .tabs{display:flex;gap:6px;margin-top:12px}
    .tab{padding:8px 12px;border-radius:8px;background:#e6eefc;color:#0b3c91;cursor:pointer}
    .tab.active{background:var(--accent);color:white}
    .card{background:var(--card);padding:12px;border-radius:10px;margin-top:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,select,textarea,button{font-size:14px}
    input,select,textarea{padding:8px;border:1px solid #e2e8f0;border-radius:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #edf2f7;text-align:left}
    .muted{color:#6b7280;font-size:13px}
    .btn{background:var(--accent);color:#fff;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
    .btn.light{background:#f3f4f6;color:#111}
    .small{font-size:13px}
    .flex{display:flex;gap:8px;align-items:center}
    .phone-list{display:flex;gap:6px;flex-wrap:wrap}
    .pill{padding:6px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a}
    .right{margin-left:auto}
    .danger{background:#fee2e2;color:#9b1c1c}
    .input-inline{display:flex;gap:8px}
    @media(max-width:800px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Aplikasi Substitusi Driver — AHT · ISD · Manager</h1>
      <div class="muted">(CSV upload + localStorage + Auto WA links)</div>
    </header>

    <div class="tabs" id="tabs"></div>

    <!-- AHT -->
    <div class="card" id="tab-aht" style="display:none">
      <h3>AHT — Input Substitusi & Database</h3>
      <div class="row">
        <div style="flex:1 1 480px">
          <label class="small">Upload CSV Database Driver</label>
          <input type="file" id="csvIn" accept=".csv" />
          <div class="muted small">Format CSV: nama,telepon,no_lambung,status_driver</div>
          <div style="margin-top:8px" class="flex">
            <button class="btn" id="loadCsv">Load & Simpan ke localStorage</button>
            <button class="btn light" id="clearDb">Hapus Database</button>
            <button class="btn light" id="exportDb">Export CSV DB</button>
          </div>
        </div>

        <div style="flex:1 1 300px">
          <label class="small">Input Manual Substitusi</label>
          <div class="row">
            <input id="subName" placeholder="Nama pengganti" />
            <input id="subPhone" placeholder="No HP (08...)" />
            <select id="subShift"><option value="pagi">Shift Pagi</option><option value="malam">Shift Malam</option></select>
          </div>
          <div style="margin-top:8px" class="flex">
            <button class="btn" id="addSub">Tambah ke List Substitusi</button>
            <button class="btn light" id="clearSubInputs">Clear</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Database Driver (centang untuk memasukkan ke list substitusi)</h4>
        <div style="max-height:220px;overflow:auto" id="dbTableWrap"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>List Substitusi Hari Ini</h4>
        <div class="flex" style="margin-bottom:8px">
          <input type="date" id="dateInput" />
          <select id="shiftSelect"><option value="pagi">Pagi</option><option value="malam">Malam</option></select>
          <button class="btn" id="processChecked">Proses Checkbox ke List</button>
          <button class="btn light" id="clearToday">Reset Hari Ini</button>
          <div class="right muted small">Saved in localStorage</div>
        </div>
        <div id="subListWrap"></div>
        <div style="margin-top:8px" class="flex">
          <button class="btn" id="copyWaSub">Copy Format WA</button>
          <button class="btn" id="openAllWaSub">Buka Semua WA</button>
          <button class="btn light" id="exportSub">Export Substitusi CSV</button>
          <div class="right muted small">Format WA: LIST DRIVER SUBSTITUSI – SHIFT (dd/mm)</div>
        </div>
      </div>
    </div>

    <!-- ISD -->
    <div class="card" id="tab-isd" style="display:none">
      <h3>ISD — Tindak Lanjut & Status Armada</h3>
      <div class="row">
        <div style="flex:1 1 600px">
          <h4>Data dari AHT (click untuk ambil ke ISD)</h4>
          <div id="isdFromAhtWrap"></div>
        </div>
        <div style="flex:1 1 300px">
          <h4>Input Armada OFF Manual</h4>
          <div class="muted small">Masukkan no lambung yang off dan pilih substitusi jika ada</div>
          <div style="margin-top:8px" class="input-inline">
            <input id="offNoLambung" placeholder="No Lambung" />
            <input id="offSubName" placeholder="Nama Substitusi (opsional)" />
            <button class="btn" id="addOff">Tambah OFF</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>List ISD (edit status tiap baris)</h4>
        <div id="isdListWrap"></div>
        <div style="margin-top:8px" class="flex">
          <button class="btn" id="copyWaIsd">Copy Format WA</button>
          <button class="btn" id="openAllWaIsd">Buka Semua WA</button>
          <button class="btn light" id="exportIsd">Export ISD CSV</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Report Armada OFF (auto-align dengan ISD)</h4>
        <div id="offReportWrap"></div>
      </div>
    </div>

    <!-- Manager -->
    <div class="card" id="tab-manager" style="display:none">
      <h3>Manager — Rangkuman Harian</h3>
      <div class="row">
        <div style="flex:1 1 400px">
          <label>Pilih Tanggal</label>
          <input type="date" id="mgrDate" />
        </div>
        <div style="flex:1 1 200px">
          <button class="btn" id="genReport">Generate Laporan</button>
          <button class="btn light" id="exportReport">Export .txt</button>
        </div>
      </div>
      <div style="margin-top:12px" id="managerReportWrap"></div>
    </div>

    <div style="margin-top:16px" class="muted small">Catatan: Semua data disimpan di <strong>localStorage</strong> perangkat. Untuk multi-perangkat, gunakan export/import CSV.</div>
  </div>

  <script>
    // Simple app state saved to localStorage
    const STORE_KEY = 'aht_isd_store_v1';
    let store = {
      db: [], // {nama,telepon,no_lambung,status_driver}
      subs: [], // {id,nama,telepon,shift,date,ready}
      isd: [], // {id,fromSubId,nama,telepon,shift,date,status,NoLambung,notes}
      off: [] // {id,no_lambung,subName,telepon,date}
    };

    // --- Utilities ---
    function uid(){return Math.random().toString(36).slice(2,9)}
    function saveStore(){localStorage.setItem(STORE_KEY, JSON.stringify(store));}
    function loadStore(){const s=localStorage.getItem(STORE_KEY); if(s){store=JSON.parse(s)}; renderAll();}
    function phoneToWa(no){ if(!no) return ''; let p=no.trim().replace(/[^0-9]/g,''); if(p.startsWith('0')) p='62'+p.slice(1); if(!p.startsWith('62')) p='62'+p; return p; }
    function csvToArray(csv){ const lines = csv.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const rows = lines.map(l=>l.split(',').map(c=>c.replace(/^"|"$/g,'').trim())); return rows; }
    function downloadFile(filename,content){ const blob=new Blob([content],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);} 

    // --- Render Tabs ---
    const tabs = [ {id:'aht',label:'AHT'}, {id:'isd',label:'ISD'}, {id:'manager',label:'Manager'} ];
    const tabsWrap = document.getElementById('tabs');
    tabs.forEach(t=>{ const el=document.createElement('div'); el.className='tab'; el.id='tabbtn-'+t.id; el.innerText=t.label; el.addEventListener('click', ()=>switchTab(t.id)); tabsWrap.appendChild(el)});
    function switchTab(id){ tabs.forEach(t=>{document.getElementById('tabbtn-'+t.id).classList.remove('active'); document.getElementById('tab-'+t.id).style.display='none'}); document.getElementById('tabbtn-'+id).classList.add('active'); document.getElementById('tab-'+id).style.display='block'; }

    // expose tab elements for CSS IDs
    document.getElementById('tabbtn-aht')?.classList.add('active');
    // initial create mapping ids - ensure container ids match
    document.getElementById('tab-aht').style.display='block';
    document.getElementById('tabbtn-aht').classList.add('active');

    // --- CSV upload for DB ---
    document.getElementById('loadCsv').addEventListener('click', ()=>{
      const f = document.getElementById('csvIn').files[0]; if(!f){alert('Pilih file CSV terlebih dahulu');return}
      const reader = new FileReader(); reader.onload = ()=>{
        try{ const rows = csvToArray(reader.result); const parsed = []; rows.forEach(r=>{ if(r.length>=2){ parsed.push({nama:r[0], telepon:r[1], no_lambung: r[2]||'', status_driver:r[3]||''}) }}); store.db = parsed; saveStore(); renderDbTable(); alert('Database berhasil di-load & tersimpan'); }catch(e){alert('CSV parse error:'+e.message)} };
      reader.readAsText(f,'utf-8');
    });

    document.getElementById('exportDb').addEventListener('click', ()=>{
      if(store.db.length===0){alert('Database kosong');return}
      const head='nama,telepon,no_lambung,status_driver\n'; const rows = store.db.map(d=>`${quote(d.nama)},${quote(d.telepon)},${quote(d.no_lambung||'')},${quote(d.status_driver||'')}`).join('\n'); downloadFile('db_drivers.csv', head+rows);
    });
    function quote(s){return '"'+(s||'').replace(/"/g,'""')+'"'}

    document.getElementById('clearDb').addEventListener('click', ()=>{ if(confirm('Hapus seluruh database driver dari lokal?')){ store.db=[]; saveStore(); renderDbTable(); alert('Database dihapus'); }});

    // Manual sub add
    document.getElementById('addSub').addEventListener('click', ()=>{
      const n = document.getElementById('subName').value.trim(); const p=document.getElementById('subPhone').value.trim(); const shift=document.getElementById('subShift').value; const date=document.getElementById('dateInput').value||new Date().toISOString().slice(0,10);
      if(!n || !p){alert('Isi nama & nomor HP');return}
      store.subs.push({id:uid(), nama:n, telepon:p, shift, date, ready:true}); saveStore(); renderSubList(); document.getElementById('subName').value=''; document.getElementById('subPhone').value='';
    });
    document.getElementById('clearSubInputs').addEventListener('click', ()=>{document.getElementById('subName').value='';document.getElementById('subPhone').value='';});

    // Process checked DB to subs
    document.getElementById('processChecked').addEventListener('click', ()=>{
      const checks = Array.from(document.querySelectorAll('input.db-check:checked')).map(c=>c.value);
      if(checks.length===0){alert('Pilih driver dari database dengan checklist');return}
      const date=document.getElementById('dateInput').value||new Date().toISOString().slice(0,10);
      const shift=document.getElementById('shiftSelect').value;
      checks.forEach(idx=>{ const d = store.db[Number(idx)]; store.subs.push({id:uid(), nama:d.nama, telepon:d.telepon, shift, date, ready:true}) });
      saveStore(); renderSubList(); renderDbTable(); alert('Driver terproses ke list substitusi')
    });

    document.getElementById('clearToday').addEventListener('click', ()=>{ if(confirm('Reset list substitusi hari ini?')){ store.subs = []; saveStore(); renderSubList(); }});

    // Render DB table
    function renderDbTable(){ const wrap = document.getElementById('dbTableWrap'); if(store.db.length===0){ wrap.innerHTML='<div class="muted small">Database kosong. Upload CSV untuk memulai.</div>'; return}
      let html='<table><thead><tr><th></th><th>Nama</th><th>Telepon</th><th>No Lambung</th><th>Status</th></tr></thead><tbody>';
      store.db.forEach((d,i)=>{ html+=`<tr><td><input type="checkbox" class="db-check" value="${i}" /></td><td>${escapeHtml(d.nama)}</td><td>${escapeHtml(d.telepon)}</td><td>${escapeHtml(d.no_lambung)}</td><td>${escapeHtml(d.status_driver)}</td></tr>`}); html+='</tbody></table>'; wrap.innerHTML = html; }

    // Render Sub List
    function renderSubList(){ const wrap=document.getElementById('subListWrap'); if(store.subs.length===0){ wrap.innerHTML='<div class="muted small">Belum ada substitusi.</div>'; return }
      let html='<table><thead><tr><th>Nama</th><th>HP</th><th>Shift</th><th>Tgl</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
      store.subs.forEach(s=>{ html+=`<tr data-id="${s.id}"><td>${escapeHtml(s.nama)}</td><td>${escapeHtml(s.telepon)}</td><td>${escapeHtml(s.shift)}</td><td>${escapeHtml(s.date)}</td><td>${s.ready? 'READY':'-'} </td><td><button class="btn light setToIsd" data-id="${s.id}">Kirim ke ISD</button> <button class="btn" data-id="${s.id}" data-action="delSub">Hapus</button></td></tr>` }); html+='</tbody></table>'; wrap.innerHTML=html;
      // attach events
      wrap.querySelectorAll('button[data-action="delSub"]').forEach(b=>{ b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'); store.subs = store.subs.filter(x=>x.id!==id); saveStore(); renderSubList(); }) });
      wrap.querySelectorAll('.setToIsd').forEach(b=>{ b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'); const s = store.subs.find(x=>x.id===id); if(s){ store.isd.push({ id: uid(), fromSubId: s.id, nama: s.nama, telepon: s.telepon, shift: s.shift, date: s.date, status:'pending', NoLambung:'', notes:'' }); saveStore(); renderIsdList(); alert('Dikirim ke ISD') } }) });
    }

    // Substitusi WA actions
    document.getElementById('copyWaSub').addEventListener('click', ()=>{
      if(store.subs.length===0){alert('Tidak ada substitusi');return}
      const date=document.getElementById('dateInput').value||new Date().toISOString().slice(0,10);
      const shift=document.getElementById('shiftSelect').value; const lines = [];
      lines.push(`LIST DRIVER SUBSTITUSI - SHIFT ${shift.toUpperCase()} (${formatDate(date)})`);
      store.subs.forEach((s,i)=>{ lines.push(`${i+1}. ${s.nama} - ${s.telepon} - READY`)});
      const txt = lines.join('\n'); navigator.clipboard.writeText(txt).then(()=>alert('Format WA disalin'));
    });
    document.getElementById('openAllWaSub').addEventListener('click', ()=>{
      if(store.subs.length===0){alert('Tidak ada substitusi');return}
      // open wa for each phone (user will be prompted by browser)
      store.subs.forEach(s=>{ const p=phoneToWa(s.telepon); const txt = encodeURIComponent(`Halo ${s.nama}, Anda tercatat READY untuk shift ${s.shift}`); window.open(`https://wa.me/${p}?text=${txt}`, '_blank'); });
    });
    document.getElementById('exportSub').addEventListener('click', ()=>{ if(store.subs.length===0){alert('Kosong');return} const head='nama,telepon,shift,date\n'; const rows = store.subs.map(s=>`${quote(s.nama)},${quote(s.telepon)},${quote(s.shift)},${quote(s.date)}`).join('\n'); downloadFile('substitusi.csv', head+rows); });

    // --- ISD ---
    function renderIsdFromAht(){ const wrap = document.getElementById('isdFromAhtWrap'); if(store.subs.length===0){ wrap.innerHTML='<div class="muted small">Belum ada data dari AHT.</div>'; return } let html='<table><thead><tr><th>Nama</th><th>HP</th><th>Shift</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody>'; store.subs.forEach(s=>{ html+=`<tr><td>${escapeHtml(s.nama)}</td><td>${escapeHtml(s.telepon)}</td><td>${escapeHtml(s.shift)}</td><td>${escapeHtml(s.date)}</td><td><button class="btn" data-id="${s.id}" data-action="takeIsd">Ambil</button></td></tr>` }); html+='</tbody></table>'; wrap.innerHTML=html; wrap.querySelectorAll('button[data-action="takeIsd"]').forEach(b=>{ b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'); const s = store.subs.find(x=>x.id===id); if(s){ store.isd.push({ id: uid(), fromSubId: s.id, nama: s.nama, telepon: s.telepon, shift: s.shift, date: s.date, status:'naik armada', NoLambung:'', notes:'' }); saveStore(); renderIsdList(); alert('Diambil ke ISD dengan status default: naik armada'); } }) }); }

    function renderIsdList(){ const wrap=document.getElementById('isdListWrap'); if(store.isd.length===0){ wrap.innerHTML='<div class="muted small">Belum ada data ISD.</div>'; return } let html='<table><thead><tr><th>Nama</th><th>HP</th><th>Shift</th><th>Tgl</th><th>Status</th><th>No Lambung</th><th>Notes</th><th>Aksi</th></tr></thead><tbody>';
      store.isd.forEach(i=>{ html+=`<tr data-id="${i.id}"><td>${escapeHtml(i.nama)}</td><td>${escapeHtml(i.telepon)}</td><td>${escapeHtml(i.shift)}</td><td>${escapeHtml(i.date)}</td><td><select class="isd-status"><option value="naik armada" ${i.status==='naik armada'?'selected':''}>Naik Armada</option><option value="tidak respon" ${i.status==='tidak respon'?'selected':''}>Tidak Respon</option><option value="turun oper" ${i.status==='turun oper'?'selected':''}>Turun Oper</option><option value="turun ijin" ${i.status==='turun ijin'?'selected':''}>Turun (ijin/sakit)</option></select></td><td><input class="nl-input" value="${escapeHtml(i.NoLambung)}" placeholder="No Lambung" /></td><td><input class="notes-input" value="${escapeHtml(i.notes)}" placeholder="Notes" /></td><td><button class="btn" data-action="saveIsd">Simpan</button> <button class="btn light" data-action="delIsd">Hapus</button></td></tr>` }); html+='</tbody></table>'; wrap.innerHTML = html;
      // events
      wrap.querySelectorAll('button[data-action="saveIsd"]').forEach(b=>{ b.addEventListener('click', ()=>{ const tr=b.closest('tr'); const id=tr.getAttribute('data-id'); const status=tr.querySelector('.isd-status').value; const nl=tr.querySelector('.nl-input').value; const notes=tr.querySelector('.notes-input').value; const idx = store.isd.findIndex(x=>x.id===id); if(idx>=0){ store.isd[idx].status=status; store.isd[idx].NoLambung=nl; store.isd[idx].notes=notes; saveStore(); renderOffReport(); alert('ISD updated') } }) });
      wrap.querySelectorAll('button[data-action="delIsd"]').forEach(b=>{ b.addEventListener('click', ()=>{ if(!confirm('Hapus baris ISD ini?')) return; const id=b.closest('tr').getAttribute('data-id'); store.isd = store.isd.filter(x=>x.id!==id); saveStore(); renderIsdList(); renderOffReport(); }) });
    }

    document.getElementById('addOff').addEventListener('click', ()=>{ const nl=document.getElementById('offNoLambung').value.trim(); const subName=document.getElementById('offSubName').value.trim(); if(!nl){alert('Isi no lambung');return} store.off.push({id:uid(), no_lambung:nl, subName: subName, telepon:'', date: new Date().toISOString().slice(0,10)}); saveStore(); renderOffReport(); document.getElementById('offNoLambung').value=''; document.getElementById('offSubName').value=''; });

    function renderOffReport(){ const wrap=document.getElementById('offReportWrap'); // align with ISD
      // take ISD entries with naik armada? Off entries exist from store.off
      const items = store.off.slice(); // merge ISD entries that have NoLambung but status turun oper or naik armada
      store.isd.forEach(i=>{ if(i.NoLambung && (i.status==='naik armada' || i.status==='turun oper')){ items.push({id:i.id, no_lambung:i.NoLambung, subName:i.nama, telepon:i.telepon, date:i.date}); } });
      if(items.length===0){ wrap.innerHTML='<div class="muted small">Belum ada report OFF.</div>'; return }
      let html='<table><thead><tr><th>No Lambung</th><th>Substitusi</th><th>HP</th><th>Tgl</th><th>Aksi</th></tr></thead><tbody>';
      items.forEach(it=>{ html+=`<tr><td>${escapeHtml(it.no_lambung)}</td><td>${escapeHtml(it.subName)}</td><td>${escapeHtml(it.telepon||'')}</td><td>${escapeHtml(it.date)}</td><td><button class="btn" data-nl="${escapeHtml(it.no_lambung)}" data-phone="${escapeHtml(it.telepon||'')}">WA</button></td></tr>` }); html+='</tbody></table>'; wrap.innerHTML = html; wrap.querySelectorAll('button[data-nl]').forEach(b=>{ b.addEventListener('click', ()=>{ const p=b.getAttribute('data-phone'); if(!p){alert('Tidak ada nomor untuk pengganti ini');return} const txt=encodeURIComponent(`Nomor lambung ${b.getAttribute('data-nl')} - mohon konfirmasi`); window.open(`https://wa.me/${phoneToWa(p)}?text=${txt}`, '_blank'); }) }); }

    document.getElementById('copyWaIsd').addEventListener('click', ()=>{ if(store.isd.length===0){alert('Kosong');return} const lines=[]; lines.push(`LIST ISD - ${new Date().toISOString().slice(0,10)}`); store.isd.forEach((i,idx)=>{ lines.push(`${idx+1}. ${i.nama} - ${i.telepon} - ${i.status} ${i.NoLambung?('(No:'+i.NoLambung+')'):''}`) }); navigator.clipboard.writeText(lines.join('\n')).then(()=>alert('Format WA ISD disalin')) });
    document.getElementById('openAllWaIsd').addEventListener('click', ()=>{ if(store.isd.length===0){alert('Kosong');return} store.isd.forEach(i=>{ if(i.telepon){ const txt=encodeURIComponent(`Halo ${i.nama}, status Anda: ${i.status} ${i.NoLambung?('No Lambung '+i.NoLambung):''}`); window.open(`https://wa.me/${phoneToWa(i.telepon)}?text=${txt}`, '_blank') } }); });
    document.getElementById('exportIsd').addEventListener('click', ()=>{ if(store.isd.length===0){alert('Kosong');return} const head='nama,telepon,shift,date,status,NoLambung,notes\n'; const rows=store.isd.map(i=>`${quote(i.nama)},${quote(i.telepon)},${quote(i.shift)},${quote(i.date)},${quote(i.status)},${quote(i.NoLambung)},${quote(i.notes)}`).join('\n'); downloadFile('isd.csv', head+rows); });

    // --- Manager Report ---
    document.getElementById('genReport').addEventListener('click', ()=>{ const date=document.getElementById('mgrDate').value||new Date().toISOString().slice(0,10); const subs = store.subs.filter(s=>s.date===date); const isds = store.isd.filter(i=>i.date===date); const offs = store.off.filter(o=>o.date===date); const lines=[]; lines.push(`LAPORAN OPERASIONAL (${formatDate(date)})`); lines.push(`Substitusi: ${subs.length}`); lines.push(`Naik Armada: ${isds.filter(i=>i.status==='naik armada').length}`); lines.push(`Turun Armada: ${isds.filter(i=>i.status==='turun oper').length}`); lines.push(`Turun (ijin/sakit): ${isds.filter(i=>i.status==='turun ijin').length}`); lines.push(`Tidak Respon: ${isds.filter(i=>i.status==='tidak respon').length}`); lines.push(`Armada OFF: ${offs.length}`); lines.push(''); lines.push('Detail:'); isds.forEach(i=>{ lines.push(`${i.nama} - ${i.status} ${i.NoLambung?('(No:'+i.NoLambung+')'):''}`) }); const wrap=document.getElementById('managerReportWrap'); wrap.innerHTML=`<pre>${escapeHtml(lines.join('\n'))}</pre>`; document.getElementById('exportReport').onclick = ()=> downloadFile(`laporan_${date}.txt`, lines.join('\n')); });

    // --- Helpers & render all ---
    function renderAll(){ renderDbTable(); renderSubList(); renderIsdFromAht(); renderIsdList(); renderOffReport(); }
    function formatDate(d){ if(!d) return ''; const dt=new Date(d); return dt.toLocaleDateString('id-ID'); }
    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // init load
    loadStore();

    // expose quick export import
    window.importCsvDb = function(csvText){ const rows = csvToArray(csvText); const parsed=[]; rows.forEach(r=>{ if(r.length>=2) parsed.push({nama:r[0],telepon:r[1],no_lambung:r[2]||'',status_driver:r[3]||''}) }); store.db = parsed; saveStore(); renderDbTable(); }

  </script>
</body>
</html>
