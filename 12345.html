<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi AHT / ISD / Manager</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#2563eb}
    body{font-family:Inter,Segoe UI,Roboto,Arial;background:var(--bg);margin:0;padding:20px;color:#111}
    .app{max-width:1100px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center}
    .tabs{display:flex;gap:8px;margin:18px 0}
    .tab{padding:8px 14px;border-radius:8px;background:transparent;border:1px solid #ddd;cursor:pointer}
    .tab.active{background:var(--card);border-color:var(--accent);color:var(--accent);box-shadow:0 2px 8px rgba(37,99,235,.08)}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;font-size:14px}
    th{background:#fafafa;text-align:left}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:white}
    .btn.ghost{background:#f3f4f6;border:1px solid #e5e7eb}
    .small{font-size:13px}
    textarea{width:100%;height:160px;padding:8px;border-radius:8px;border:1px solid #e5e7eb}
    input[type=file]{display:block}
    .status{font-weight:600}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-size:12px}
    .field{margin-bottom:8px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text],select{width:100%;padding:8px;border-radius:8px;border:1px solid #e5e7eb}
    .meta{font-size:13px;color:#6b7280}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Aplikasi AHT · ISD · Manager</h1>
      <div class="meta">Local-only demo — data tersimpan di browser (localStorage)</div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="aht">AHT</button>
      <button class="tab" data-tab="isd">ISD</button>
      <button class="tab" data-tab="manager">Manager</button>
    </div>

    <div id="content">
      <!-- AHT -->
      <div class="card" id="tab-aht">
        <div class="grid">
          <div>
            <div class="field">
              <label>Upload database driver (CSV atau Excel)</label>
              <input id="file" type="file" accept=".csv, .xlsx, .xls" />
              <div class="muted small">Kolom yang dianjurkan: nama,phone,status (opsional)</div>
            </div>

            <div class="field">
              <label>Tambah manual</label>
              <input id="manualName" type="text" placeholder="Nama driver" />
              <input id="manualPhone" type="text" placeholder="No HP (contoh: +6281...)" style="margin-top:6px" />
              <div style="margin-top:8px"><button class="btn primary" id="addManual">Tambah</button></div>
            </div>

            <div class="field">
              <label>Tanggal Operasional</label>
              <input id="tglOperasional" type="date" />
            </div>

            <div class="field">
              <label>Pilih shift</label>
              <select id="shiftSelect">
                <option value="malam">Malam</option>
                <option value="pagi">Pagi</option>
              </select>
            </div>

            <div style="margin-top:12px" class="field">
              <button class="btn primary" id="markReady">Set Status READY untuk yang dicentang</button>
              <button class="btn ghost" id="clearSelection">Bersihkan centang</button>
            </div>

            <div style="margin-top:12px" class="field">
              <button class="btn" id="exportList">Tarik list (teks untuk WhatsApp)</button>
              <button class="btn" id="copyWA">Copy ke clipboard</button>
              <button class="btn" id="openWA">Buka WhatsApp Web (isi teks)</button>
            </div>

            <div style="margin-top:12px">
              <label>Hasil (copy — paste ke WA)</label>
              <textarea id="waText" placeholder="List akan muncul di sini..."></textarea>
            </div>

            <div style="margin-top:12px">
              <button class="btn primary" id="sendToISD">Kirim input terpilih ke ISD</button>
            </div>
          </div>

          <div>
            <h3>Database Driver</h3>
            <div class="card" style="max-height:480px;overflow:auto">
              <table id="driverTable"><thead><tr><th></th><th>Nama</th><th>No HP</th><th>Shift</th><th>Status</th></tr></thead><tbody></tbody></table>
            </div>
            <div style="margin-top:8px" class="meta">Klik nama untuk edit, centang untuk memilih.</div>
          </div>
        </div>
      </div>

      <!-- ISD -->
      <div class="card" id="tab-isd" style="display:none;margin-top:12px">
        <div class="grid">
          <div>
            <h3>Queue ISD (umpan balik)</h3>
            <div class="card" style="max-height:420px;overflow:auto">
              <table id="isdTable"><thead><tr><th>Nama</th><th>HP</th><th>Shift</th><th>Naik</th><th>No Response</th><th>Turun</th><th>Aksi</th></tr></thead><tbody></tbody></table>
            </div>
            <div style="margin-top:8px">
              <label>Edit/isi profiling untuk baris terpilih</label>
              <input id="naikArmada" type="text" placeholder="Naik armada (no lambung)" />
              <input id="noResponse" type="text" placeholder="No response (keterangan)" style="margin-top:6px" />
              <input id="turunArmada" type="text" placeholder="Turun (oper lambung)" style="margin-top:6px" />
              <div style="margin-top:8px"><button class="btn primary" id="saveISD">Simpan</button> <button class="btn ghost" id="exportISD">Tarik ISD sebagai teks</button></div>
            </div>
          </div>

          <div>
            <h3>Preview teks</h3>
            <label>Hasil ISD (copy ke WA / catatan)</label>
            <textarea id="isdText" placeholder="ISD text..."></textarea>
            <div style="margin-top:8px"><button class="btn" id="clearISD">Bersihkan queue ISD</button></div>
          </div>
        </div>
      </div>

      <!-- Manager -->
      <div class="card" id="tab-manager" style="display:none;margin-top:12px">
        <h3>Manager — Rekapan & Report</h3>
        <div class="field">
          <button class="btn primary" id="generateReport">Buat ringkasan laporan (teks)</button>
          <button class="btn ghost" id="exportCSV">Export CSV (semua data)</button>
        </div>
        <div style="margin-top:12px">
          <label>Rekapan</label>
          <textarea id="managerText" placeholder="Ringkasan laporan akan muncul di sini"></textarea>
        </div>
      </div>

    </div>
  </div>

<script>
// Simple app: stores driver list and ISD queue in localStorage
const LS_DRIVERS = 'aht_drivers_v1';
const LS_ISD = 'aht_isd_v1';
let drivers = JSON.parse(localStorage.getItem(LS_DRIVERS) || '[]');
let isd = JSON.parse(localStorage.getItem(LS_ISD) || '[]');

// Utility
function save(){ localStorage.setItem(LS_DRIVERS, JSON.stringify(drivers)); localStorage.setItem(LS_ISD, JSON.stringify(isd)); render(); }
function uid(){return Math.random().toString(36).slice(2,9)}

// helper: format tanggal ke format ID (8 Des 2025)
function formatDateID(iso){
  if(!iso) return '(tgl belum dipilih)';
  try{
    const d = new Date(iso);
    const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }catch(e){return iso}
}

// Tabs
document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const t=b.dataset.tab;
  document.querySelectorAll('#content > .card').forEach(c=>c.style.display='none');
  document.getElementById('tab-'+t).style.display='block';
}));

// Render tables
function render(){
  const tbody = document.querySelector('#driverTable tbody'); tbody.innerHTML='';
  drivers.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><input data-id="${d.id}" class="sel" type="checkbox"></td>
      <td class="name" data-id="${d.id}" style="cursor:pointer">${d.name}</td>
      <td>${d.phone||''}</td>
      <td>${d.shift||''}</td>
      <td><span class="pill">${d.status||'--'}</span></td>`;
    tbody.appendChild(tr);
  });

  // attach name click
  document.querySelectorAll('#driverTable .name').forEach(el=>el.addEventListener('click',e=>{
    const id=e.target.dataset.id; const d=drivers.find(x=>x.id==id);
    const newName = prompt('Edit nama', d.name);
    if(newName!==null){ d.name=newName; save(); }
  }));

  // ISD
  const it = document.querySelector('#isdTable tbody'); it.innerHTML='';
  isd.forEach((row)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${row.name}</td><td>${row.phone||''}</td><td>${row.shift||''}</td>
      <td>${row.naik||''}</td><td>${row.noresp||''}</td><td>${row.turun||''}</td>
      <td><button data-id="${row.id}" class="btn small edit">Edit</button> <button data-id="${row.id}" class="btn small del">Del</button></td>`;
    it.appendChild(tr);
  });
  // attach edit/del
  document.querySelectorAll('#isdTable .edit').forEach(b=>b.addEventListener('click',e=>{
    const id=e.target.dataset.id; const row=isd.find(x=>x.id==id);
    document.getElementById('naikArmada').value=row.naik||'';
    document.getElementById('noResponse').value=row.noresp||'';
    document.getElementById('turunArmada').value=row.turun||'';
    // mark selected in DOM for save
    document.getElementById('saveISD').dataset.id=id;
  }));
  document.querySelectorAll('#isdTable .del').forEach(b=>b.addEventListener('click',e=>{
    const id=e.target.dataset.id; if(confirm('Hapus entry ISD?')){ isd = isd.filter(x=>x.id!==id); save(); }
  }));
}

// Add manual
document.getElementById('addManual').addEventListener('click',()=>{
  const n=document.getElementById('manualName').value.trim(); const p=document.getElementById('manualPhone').value.trim();
  if(!n) return alert('Masukkan nama');
  drivers.push({id:uid(),name:n,phone:p,shift:'',status:'--'}); save();
  document.getElementById('manualName').value=''; document.getElementById('manualPhone').value='';
});

// File upload (CSV or XLSX)
const fileInput = document.getElementById('file');
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const name = f.name.toLowerCase();
  if(name.endsWith('.csv')){
    const text = await f.text(); parseCSV(text);
  } else {
    // try xlsx via SheetJS if available
    try{
      const data = await f.arrayBuffer();
      const wb = XLSX.read(data, {type:'array'});
      const wsName = wb.SheetNames[0]; const ws=wb.Sheets[wsName]; const json = XLSX.utils.sheet_to_json(ws);
      json.forEach(r=>{
        const n=r.nama||r.name||r.nama_driver||r.NAMA||r.Name; const p=r.phone||r.hp||r.no_hp||r.phone_number; drivers.push({id:uid(),name:n||'Unnamed',phone:p||'',shift:'',status:'--'});
      }); save();
    }catch(err){ alert('Gagal baca file Excel. Coba CSV.'); }
  }
});
function parseCSV(text){
  const lines = text.split(/?
/).filter(l=>l.trim());
  const headers = lines[0].split(/,|;|	/).map(h=>h.trim().toLowerCase());
  for(let i=1;i<lines.length;i++){ const cols = lines[i].split(/,|;|	/); if(cols.length===0) continue; const obj={}; headers.forEach((h,idx)=>obj[h]=cols[idx]||''); const n=obj.nama||obj.name||obj.nama_driver||obj.NAMA||obj.Name; const p=obj.phone||obj.hp||obj.no_hp||obj.phone_number; drivers.push({id:uid(),name:n||('Row '+i),phone:p||'',shift:'',status:'--'}); }
  save();
}

// Mark ready for checked
document.getElementById('markReady').addEventListener('click',()=>{
  const shift = document.getElementById('shiftSelect').value;
  document.querySelectorAll('#driverTable .sel:checked').forEach(cb=>{
    const id=cb.dataset.id; const d=drivers.find(x=>x.id==id); if(d){ d.status='READY'; d.shift=shift; }
  }); save();
});

document.getElementById('clearSelection').addEventListener('click',()=>{ document.querySelectorAll('#driverTable .sel').forEach(c=>c.checked=false); });

// Export list text for WA
document.getElementById('exportList').addEventListener('click',()=>{
  const shift = document.getElementById('shiftSelect').value;
  const tglIso = document.getElementById('tglOperasional').value || '';
  const tgl = formatDateID(tglIso);
  const rows = [];
  document.querySelectorAll('#driverTable .sel:checked').forEach(cb=>{
    const id=cb.dataset.id; const d=drivers.find(x=>x.id==id);
    if(d){ rows.push(`${d.name} | ${d.phone || '-'} | shift: ${d.shift||shift} | status: ${d.status||'--'}`); }
  });
  const text = `LIST MITRA (shift: ${shift})
Tanggal: ${tgl}

` + rows.join('
');
  document.getElementById('waText').value=text;
});

// copy to clipboard
if(document.getElementById('copyWA')) document.getElementById('copyWA').addEventListener('click',()=>{
  const t = document.getElementById('waText').value; if(!t) return alert('Tidak ada teks untuk di-copy'); navigator.clipboard.writeText(t).then(()=>alert('Teks disalin ke clipboard'));
});

// open WhatsApp Web with prefilled text (note: terbatas oleh panjang url)
if(document.getElementById('openWA')) document.getElementById('openWA').addEventListener('click',()=>{
  const t = document.getElementById('waText').value; if(!t) return alert('Tidak ada teks untuk dikirim ke WA');
  const encoded = encodeURIComponent(t);
  const url = `https://web.whatsapp.com/send?text=${encoded}`;
  window.open(url,'_blank');
});

// Send to ISD (selected drivers)
document.getElementById('sendToISD').addEventListener('click',()=>{
  const shift = document.getElementById('shiftSelect').value;
  document.querySelectorAll('#driverTable .sel:checked').forEach(cb=>{
    const id=cb.dataset.id; const d=drivers.find(x=>x.id==id);
    if(d){ isd.push({id:uid(),name:d.name,phone:d.phone,shift:shift,naik:'',noresp:'',turun:''}); }
  }); save(); alert('Terkirim ke ISD');
});

// ISD save
document.getElementById('saveISD').addEventListener('click',()=>{
  const id=document.getElementById('saveISD').dataset.id; if(!id) return alert('Pilih baris ISD (Edit) dulu');
  const naik=document.getElementById('naikArmada').value.trim(); const noresp=document.getElementById('noResponse').value.trim(); const turun=document.getElementById('turunArmada').value.trim();
  const row = isd.find(x=>x.id==id); if(row){ row.naik=naik; row.noresp=noresp; row.turun=turun; save(); document.getElementById('saveISD').dataset.id=''; document.getElementById('naikArmada').value=''; document.getElementById('noResponse').value=''; document.getElementById('turunArmada').value=''; }
});

// Export ISD as text
document.getElementById('exportISD').addEventListener('click',()=>{
  const tglIso = document.getElementById('tglOperasional').value || '';
  const tgl = formatDateID(tglIso);
  const parts = isd.map(r=>`${r.name} | ${r.phone||'-'} | shift:${r.shift||'-'} | naik:${r.naik||'-'} | noresp:${r.noresp||'-'} | turun:${r.turun||'-'}`);
  document.getElementById('isdText').value = `QUEUE ISD — SHIFT: ${isd.length ? isd[0].shift.toUpperCase() : '-'}
Tanggal: ${tgl}

` + isd.map((r,i)=>`${i+1}. ${r.name} — ${r.phone||'-'}
   Naik Armada : ${r.naik||'-'}
   No Resp     : ${r.noresp||'-'}
   Turun       : ${r.turun||'-'}
`).join('');('
');
});

// clear ISD
document.getElementById('clearISD').addEventListener('click',()=>{ if(confirm('Hapus semua queue ISD?')){ isd=[]; save(); } });

// Manager: generate summary
function generateSummary(){
  const total = drivers.length; const ready = drivers.filter(d=>d.status==='READY').length;
  const perShift = drivers.reduce((acc,d)=>{ acc[d.shift||'unknown']=(acc[d.shift||'unknown']||0)+1; return acc; },{});
  const isdPending = isd.length;
  const tglIso = document.getElementById('tglOperasional').value || '';
  const tgl = formatDateID(tglIso);
  let txt = `REKAP (Tanggal: ${tgl})
Total driver: ${total}
Ready: ${ready}
ISD queue: ${isdPending}

Per shift:
`;
  for(const k in perShift) txt += ` - ${k}: ${perShift[k]}
`;
  // detail READY list
  const readyList = drivers.filter(d=>d.status==='READY').map(d=>`${d.name} | ${d.phone||'-'} | shift:${d.shift||'-'}`).join('
');
  txt += `
Daftar READY:
${readyList}
`;
  return txt;
}

document.getElementById('generateReport').addEventListener('click',()=>{ document.getElementById('managerText').value = generateSummary(); });

// Export CSV (drivers + status)
document.getElementById('exportCSV').addEventListener('click',()=>{
  const rows = [['id','name','phone','shift','status']]; drivers.forEach(d=>rows.push([d.id,d.name,d.phone,d.shift,d.status]));
  const csv = rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('
');
  const blob = new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='drivers_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// small init
render();

// Try to load SheetJS dynamically for excel support
(function loadXLSX(){
  const s=document.createElement('script'); s.src='https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js'; s.onload=()=>{ window.XLSX = window.XLSX || window.xlsx; console.log('SheetJS loaded'); }; document.head.appendChild(s);
})();
</script>

</body>
</html>