<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aplikasi 2â€‘Arah Final â€” AHT â†” ISD</title>
<style>
:root{--accent:#0f62fe;--muted:#666;--ok:#2d9a4a;--warn:#f2b500;--err:#e04b4b}
body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0;background:#f4f6fb;color:#0b1220}
.app{max-width:1100px;margin:18px auto;padding:16px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
h1{font-size:18px;margin:0}
.card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(11,17,32,0.06);margin-bottom:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,select,button,textarea{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(15,98,254,0.12)}
.small{padding:6px 8px;font-size:13px}
.muted{color:var(--muted);font-size:13px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px 10px;border-bottom:1px solid #eef2f6;text-align:left}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
.s-prep{background:linear-gradient(90deg,#d6ecff,#6fb3ff);color:#05386b}
.s-ready{background:linear-gradient(90deg,#b8e0c9,#2d9a4a);color:#fff}
.s-cancel{background:linear-gradient(90deg,#ffd7d7,#e04b4b);color:#fff}
.s-noresp{background:linear-gradient(90deg,#fff3cd,#f2b500);color:#533f03}
.kiri{flex:1}
.kanan{flex:1}
.flex-between{display:flex;justify-content:space-between;align-items:center}
@media (max-width:900px){.row{flex-direction:column}.flex-between{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Aplikasi 2â€‘Arah Final â€” AHT â†” ISD</h1>
    <div class="muted">Role:
      <select id="roleSwitch" style="margin-left:8px;padding:6px 8px;border-radius:6px">
        <option value="AHT">AHT (Persiapan)</option>
        <option value="ISD">ISD (Verifikasi)</option>
      </select>
    </div>
  </div>

  <div class="card" id="dbCard">
    <strong>Database Driver (List Tembak + Substitusi + Batangan)</strong>
    <div style="margin-top:8px" class="muted">Centang driver yang ingin disiapkan â€” pilih tanggal & shift lalu klik <strong>Siapkan Terpilih</strong>.</div>
    <div class="row" style="margin-top:8px">
      <input type="date" id="selectDate" />
      <select id="selectShift"><option>Pagi</option><option>Malam</option></select>
      <button class="btn small" id="prepareSelected">Siapkan Terpilih</button>
      <button class="btn ghost small" id="clearSelectionDb">Batal Pilih</button>
      <input id="dbFilter" placeholder="Cari nama / grup / no hp" style="margin-left:8px" />
    </div>
    <div style="margin-top:10px;overflow:auto;max-height:260px">
      <table class="table" id="dbTable">
        <thead><tr><th></th><th>Nama</th><th>No HP</th><th>Grup</th></tr></thead>
        <tbody id="dbBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="flex-between">
      <div class="kiri">
        <strong>Daftar Persiapan (AHT â†’ ISD)</strong>
        <div style="margin-top:6px" class="muted">List yang dibuat AHT â€” ISD akan memverifikasi lalu update status.</div>
      </div>
      <div class="kanan">
        <div class="muted">Aksi cepat:</div>
        <div style="margin-top:6px" class="row">
          <button class="small btn" id="selectAllPrep">Pilih Semua</button>
          <button class="small btn ghost" id="deselectAllPrep">Batal Pilih</button>
          <button class="small btn ghost" id="exportPrep">Export CSV</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px;overflow:auto;max-height:320px">
      <table class="table" id="prepTable">
        <thead><tr><th></th><th>Nama</th><th>No HP</th><th>Grup</th><th>Tanggal</th><th>Shift</th><th>Status</th><th>Aksi (ISD)</th></tr></thead>
        <tbody id="prepBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="isdCard" style="display:none">
    <strong>ISD â€” Verifikasi & Update</strong>
    <div class="row" style="margin-top:8px">
      <div class="muted">Pilih baris lalu update status:</div>
      <div style="margin-top:8px" class="row">
        <button class="btn small" id="btnReady">READY</button>
        <input id="inputArmada" placeholder="No Armada / Lambung" style="width:160px" />
        <button class="btn small" id="btnAssign">Assign Armada</button>
        <button class="btn ghost small" id="btnCancel">CANCEL</button>
        <button class="btn ghost small" id="btnNoResp">NO RESPONSE</button>
        <button class="btn ghost small" id="btnSnapshot">Simpan Snapshot (History)</button>
      </div>
    </div>
    <div style="margin-top:8px" class="muted">History dapat dimuat lewat tombol Load History di bawah.</div>
    <div style="margin-top:10px">
      <strong>History</strong>
      <div class="row" style="margin-top:8px">
        <input type="date" id="histDate" />
        <select id="histShift"><option value="">Semua Shift</option><option>Pagi</option><option>Malam</option></select>
        <button class="small btn ghost" id="btnLoadHist">Load History</button>
        <button class="small btn ghost" id="btnClearHist">Hapus History Tanggal</button>
      </div>
    </div>
  </div>

  <div class="card">
    <strong>Output Mitra (Format WA)</strong>
    <div style="margin-top:8px" class="muted">Klik Generate â†’ Copy atau Buka WhatsApp untuk kirim.</div>
    <div style="margin-top:8px" class="row">
      <input type="date" id="outDate" /><select id="outShift"><option>Pagi</option><option>Malam</option></select>
      <button class="btn small" id="genOutput">Generate</button>
      <button class="btn ghost small" id="copyOutput">Copy</button>
      <button class="btn ghost small" id="waOutput">Buka WhatsApp</button>
    </div>
    <div style="margin-top:8px">
      <textarea id="outArea" rows="6" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eef2f6;font-family:monospace" readonly></textarea>
    </div>
  </div>

</div>

<script>
// Driver database from user's lists (Koperasi + AHT Grup1 + AHT Grup2 + Substitusi + Batangan)
const driverDB = [
  {name:'Muayyad', phone:'+6281999946261', group:'Koperasi'},
  {name:'Agus Efendi', phone:'+6282142534081', group:'Koperasi'},
  {name:'Rizaldi Ahmad', phone:'+6282210291151', group:'Koperasi'},
  {name:'Andik Prasetyo', phone:'+6285855114262', group:'Koperasi'},
  {name:'Dodi Agung', phone:'+6285231170258', group:'Koperasi'},
  {name:'Poniman', phone:'+6281249263864', group:'Koperasi'},
  {name:'M. Arisjal', phone:'+6281330182949', group:'Koperasi'},

  // AHT Grup 1
  {name:'Yanuar', phone:'+6281252741692', group:'AHT Grup 1'},
  {name:'Makki', phone:'+6285103228871', group:'AHT Grup 1'},
  {name:'Ahmadi', phone:'+6285280267880', group:'AHT Grup 1'},
  {name:'Hadi', phone:'+628819580569', group:'AHT Grup 1'},
  {name:'Adi W', phone:'+6282291705474', group:'AHT Grup 1'},
  {name:'Mamad', phone:'+6282140991199', group:'AHT Grup 1'},
  {name:'Sarui', phone:'+6289601115699', group:'AHT Grup 1'},
  {name:'Rasid', phone:'+6281249348837', group:'AHT Grup 1'},
  {name:'Badrus', phone:'+6281358653330', group:'AHT Grup 1'},
  {name:'Samsul A', phone:'+6281294731937', group:'AHT Grup 1'},
  {name:'M. Ikhsan', phone:'+6282231293629', group:'AHT Grup 1'},
  {name:'Machmud', phone:'+6281235910554', group:'AHT Grup 1'},

  // AHT Grup 2
  {name:'Maulana', phone:'+6285733141560', group:'AHT Grup 2'},
  {name:'Lukmanul H', phone:'+6282143746828', group:'AHT Grup 2'},
  {name:'Dedi W', phone:'+6285730650146', group:'AHT Grup 2'},
  {name:'Budi S', phone:'+6282336027742', group:'AHT Grup 2'},
  {name:'Asnan', phone:'+6281349347672', group:'AHT Grup 2'},
  {name:'Syafrianto', phone:'+6281266947228', group:'AHT Grup 2'},
  {name:'Purnomo', phone:'+6289512116733', group:'AHT Grup 2'},
  {name:'Muslih', phone:'+628388849541', group:'AHT Grup 2'},
  {name:'Kaharudin', phone:'+6281323303738', group:'AHT Grup 2'},
  {name:'M. Hamzah', phone:'+6281388647081', group:'AHT Grup 2'},
  {name:'M. Daman', phone:'+6285739695837', group:'AHT Grup 2'},

  // Batangan
  {name:'Dayat', phone:'+6281259690075', group:'Batangan'},

  // Substitusi & tambahan
  {name:'Didi S', phone:'+6285385532458', group:'Substitusi'},
  {name:'Muhammad Riszky', phone:'+6288989779363', group:'Substitusi'},
  {name:'Suliman', phone:'+6281703273660', group:'Substitusi'},
  {name:'Fauzan', phone:'+6282141100091', group:'Substitusi'},
  {name:'Umar', phone:'+6282233936079', group:'Substitusi'},
  {name:'Adi W (alt)', phone:'+6288989779363', group:'Substitusi'}
];

// Storage keys
const KEY_PREP = 'kiki_prep_final_v1';
const KEY_HIST = 'kiki_prep_hist_final_v1';

let prep = JSON.parse(localStorage.getItem(KEY_PREP) || '[]');
let hist = JSON.parse(localStorage.getItem(KEY_HIST) || '{}');

// DOM
const roleSwitch = document.getElementById('roleSwitch');
const dbBody = document.getElementById('dbBody');
const dbFilter = document.getElementById('dbFilter');
const selectDate = document.getElementById('selectDate');
const selectShift = document.getElementById('selectShift');
const prepareSelected = document.getElementById('prepareSelected');
const clearSelectionDb = document.getElementById('clearSelectionDb');

const prepBody = document.getElementById('prepBody');
const selectAllPrep = document.getElementById('selectAllPrep');
const deselectAllPrep = document.getElementById('deselectAllPrep');
const exportPrep = document.getElementById('exportPrep');

const isdCard = document.getElementById('isdCard');
const btnReady = document.getElementById('btnReady');
const btnAssign = document.getElementById('btnAssign');
const btnCancel = document.getElementById('btnCancel');
const btnNoResp = document.getElementById('btnNoResp');
const btnSnapshot = document.getElementById('btnSnapshot');
const inputArmada = document.getElementById('inputArmada');
const btnAssignArmada = document.getElementById('btnAssign');

const outDate = document.getElementById('outDate');
const outShift = document.getElementById('outShift');
const genOutput = document.getElementById('genOutput');
const outArea = document.getElementById('outArea');
const copyOutput = document.getElementById('copyOutput');
const waOutput = document.getElementById('waOutput');

const histDate = document.getElementById('histDate');
const histShift = document.getElementById('histShift');
const btnLoadHist = document.getElementById('btnLoadHist');
const btnClearHist = document.getElementById('btnClearHist');

// Role switch UI
roleSwitch.addEventListener('change', ()=>{
  if(roleSwitch.value === 'ISD'){ isdCard.style.display='block'; }
  else { isdCard.style.display='none'; }
});

// Render DB table
function renderDB(filter=''){
  dbBody.innerHTML='';
  const q = (filter||'').toLowerCase();
  driverDB.forEach((d,idx)=>{
    if(q && !(d.name.toLowerCase().includes(q) || d.phone.includes(q) || d.group.toLowerCase().includes(q))) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="checkbox" data-idx="${idx}"></td><td>${escapeHtml(d.name)}</td><td>${escapeHtml(d.phone)}</td><td>${escapeHtml(d.group)}</td>`;
    dbBody.appendChild(tr);
  });
}
dbFilter.addEventListener('input', ()=> renderDB(dbFilter.value));
renderDB();

// Prepare selected drivers (AHT)
prepareSelected.addEventListener('click', ()=>{
  const date = selectDate.value;
  const shift = selectShift.value;
  if(!date) return alert('Pilih tanggal terlebih dulu');
  const checks = Array.from(dbBody.querySelectorAll('input[type=checkbox]:checked'));
  if(!checks.length) return alert('Pilih minimal 1 driver dari database');
  const added = [];
  checks.forEach(ch=>{
    const idx = +ch.dataset.idx;
    const d = driverDB[idx];
    // avoid duplicates by name+date+shift
    const exists = prep.find(p=> p.name.toLowerCase()===d.name.toLowerCase() && p.date===date && p.shift===shift);
    if(!exists){
      const obj = { id: uid(), name: d.name, phone: d.phone, group: d.group, date, shift, status:'Prepared', assigned:'', note:'', created:new Date().toISOString() };
      prep.push(obj); added.push(obj);
    }
    ch.checked = false;
  });
  localStorage.setItem(KEY_PREP, JSON.stringify(prep));
  renderPrep();
  alert('Ditambahkan: '+added.length);
});

clearSelectionDb.addEventListener('click', ()=>{
  dbBody.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false);
});

// Render prep list
function renderPrep(filter=''){
  prepBody.innerHTML='';
  const q = (filter||'').toLowerCase();
  prep.forEach((p,idx)=>{
    if(q && !(p.name.toLowerCase().includes(q) || p.phone.includes(q) || (p.group||'').toLowerCase().includes(q) || (p.date||'').includes(q))) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="checkbox" data-id="${p.id}" ${p._sel? 'checked':''}></td>
      <td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.phone)}</td><td>${escapeHtml(p.group)}</td>
      <td>${escapeHtml(p.date)}</td><td>${escapeHtml(p.shift)}</td>
      <td>${statusBadge(p)}</td>
      <td><button class="small" data-act="view" data-id="${p.id}">View</button>${roleSwitch.value==='ISD'? ' <button class="small" data-act="isd" data-id="'+p.id+'">ISD</button>':''}</td>`;
    prepBody.appendChild(tr);
    tr.querySelector('input[type=checkbox]').addEventListener('change', e=>{ const id=e.target.dataset.id; const it = prep.find(x=>x.id===id); if(it) it._sel = e.target.checked; localStorage.setItem(KEY_PREP, JSON.stringify(prep)); });
    tr.querySelector('button[data-act="view"]').addEventListener('click', ()=>{ alert(viewText(p)); });
    const isdBtn = tr.querySelector('button[data-act="isd"]'); if(isdBtn) isdBtn.addEventListener('click', ()=> openISD(p.id));
  });
}
function statusBadge(p){
  if(p.status==='Prepared') return `<span class="badge s-prep">Prepared</span>`;
  if(p.status==='Ready') return `<span class="badge s-ready">Ready (Armada: ${escapeHtml(p.assigned||'-')})</span>`;
  if(p.status==='Cancelled') return `<span class="badge s-cancel">Cancelled</span>`;
  if(p.status==='NoResponse') return `<span class="badge s-noresp">No Response</span>`;
  return `<span class="badge">${escapeHtml(p.status||'')}</span>`;
}
function viewText(p){ return `${p.name}\n${p.phone}\n${p.group}\n${p.date} ${p.shift}\nStatus: ${p.status}\nArmada: ${p.assigned||'-'}\nNote: ${p.note||'-'}`; }

renderPrep();

// ISD actions helpers
function getSelectedPrep(){ return prep.filter(x=> x._sel); }
function savePrep(){ localStorage.setItem(KEY_PREP, JSON.stringify(prep)); renderPrep(); }

btnReady.addEventListener('click', ()=>{
  const sel = getSelectedPrep(); if(!sel.length) return alert('Pilih minimal 1 entri');
  sel.forEach(s=>{ s.status='Ready'; s.note=''; });
  savePrep(); saveSnapshot(); alert('Status diubah ke READY');
});
btnAssign.addEventListener('click', ()=>{
  const no = inputArmada.value.trim(); if(!no) return alert('Masukkan nomor armada');
  const sel = getSelectedPrep(); if(!sel.length) return alert('Pilih minimal 1 entri');
  sel.forEach(s=>{ s.status='Ready'; s.assigned=no; s.note='Assigned by ISD at '+new Date().toLocaleString(); });
  inputArmada.value=''; savePrep(); saveSnapshot(); alert('Armada di-assign');
});
btnCancel.addEventListener('click', ()=>{
  const reason = prompt('Alasan cancel (opsional):','Izin / Tidak bisa naik');
  const sel = getSelectedPrep(); if(!sel.length) return alert('Pilih minimal 1 entri');
  sel.forEach(s=>{ s.status='Cancelled'; s.note = reason || ''; });
  savePrep(); saveSnapshot(); alert('Diubah menjadi Cancelled');
});
btnNoResp.addEventListener('click', ()=>{
  const sel = getSelectedPrep(); if(!sel.length) return alert('Pilih minimal 1 entri');
  sel.forEach(s=>{ s.status='NoResponse'; s.note='No response at '+new Date().toLocaleString(); });
  savePrep(); saveSnapshot(); alert('Diubah menjadi No Response');
});

// select/deselect prep
selectAllPrep.addEventListener('click', ()=>{ prep.forEach(p=> p._sel = true); savePrep(); });
deselectAllPrep.addEventListener('click', ()=>{ prep.forEach(p=> p._sel = false); savePrep(); });

// export prep csv
exportPrep.addEventListener('click', ()=>{
  const rows = [['Nama','NoHP','Grup','Tanggal','Shift','Status','Armada','Note']];
  prep.forEach(p=> rows.push([p.name,p.phone,p.group,p.date,p.shift,p.status,p.assigned||'',p.note||'']));
  const csv = rows.map(r=> r.map(c=> `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='prep_list.csv'; a.click(); URL.revokeObjectURL(url);
});

// Output generation (Format WA - pilihan Yoga)
genOutput.addEventListener('click', ()=>{
  const date = outDate.value; const shift = outShift.value;
  if(!date) return alert('Pilih tanggal output');
  const list = prep.filter(p=> p.date===date && p.shift===shift);
  if(!list.length) return alert('Tidak ada entri untuk tanggal/shift ini');
  // Format WA
  const header = `ðŸ“Œ LIST MITRA ${shift.toUpperCase()} â€” ${date}`;
  const lines = list.map((p,i)=> `${i+1}. ${p.name} â€” ${p.phone} (${p.group})`);
  outArea.value = header + '\n' + lines.join('\n');
});
copyOutput.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(outArea.value); alert('Tersalin'); }catch(e){ alert('Gagal salin'); } });
waOutput.addEventListener('click', ()=>{ const t = encodeURIComponent(outArea.value || ''); const url = /Android|iPhone|iPad|iPod/.test(navigator.userAgent) ? `https://wa.me/?text=${t}` : `https://web.whatsapp.com/send?text=${t}`; window.open(url,'_blank'); });

// History snapshot save/load
function saveSnapshot(){
  const d = new Date().toISOString().slice(0,10);
  const key = d + '_' + new Date().getTime();
  hist[key] = { created: new Date().toISOString(), list: JSON.parse(JSON.stringify(prep)) };
  localStorage.setItem(KEY_HIST, JSON.stringify(hist));
}
btnSnapshot.addEventListener('click', ()=>{ saveSnapshot(); alert('Snapshot disimpan ke history'); });

btnLoadHist.addEventListener('click', ()=>{
  const d = histDate.value; const sh = histShift.value;
  if(!d) return alert('Pilih tanggal');
  const keys = Object.keys(hist).filter(k=> k.startsWith(d+'_'));
  if(!keys.length) return alert('Tidak ada history untuk tanggal ini');
  let items = [];
  keys.forEach(k=> items = items.concat(hist[k].list));
  if(sh) items = items.filter(i=> i.shift===sh);
  if(!items.length) return alert('Tidak ada entri untuk filter ini');
  const txt = items.map((it,idx)=> `${idx+1}. ${it.name} â€” ${it.phone} (${it.group}) [${it.date} ${it.shift}] Status: ${it.status} Armada: ${it.assigned||'-'}`).join('\n');
  alert('History '+d+':\n\n'+txt);
});
btnClearHist.addEventListener('click', ()=>{
  const d = histDate.value; if(!d) return alert('Pilih tanggal'); const keys = Object.keys(hist).filter(k=> k.startsWith(d+'_')); if(!keys.length) return alert('Tidak ada history'); if(!confirm('Hapus history tanggal '+d+'?')) return; keys.forEach(k=> delete hist[k]); localStorage.setItem(KEY_HIST, JSON.stringify(hist)); alert('History dihapus');
});

// Utility
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":\"&#39;\"}[c])); }

// Auto-save prep every 2 minutes
setInterval(()=> localStorage.setItem(KEY_PREP, JSON.stringify(prep)), 120000);

</script>
</body>
</html>
